# 2025-12-20 学習ログ

## やったこと
- Remote backend（S3 + DynamoDB） をTerraformで構築（bootstrap）
  - infra/bootstrap/state_backend にて state管理基盤を作成
  - terraform init → plan/apply で tfstate保存用S3 と ロック用DynamoDB を作成
  - terraform output で tfstate bucket / lock table の名前を確認

- dev環境をRemote backendへ切り替え
  - infra/envs/dev に backend.tf を追加（bucket名・dynamodb_table名は直書き）
  - terraform init → terraform init -migrate-state を実施

- Remote backend上でTerraformが動くことを確認
  - terraform plan で state lock（DynamoDB） が動くことを確認（Acquiring state lock...）
  - terraform apply でVPC一式（6リソース）を作成
  - terraform state list / state pull で S3上のstateが更新されていることを確認
  - terraform destroy でVPC一式を削除（コスト回避）

- AWS rootのMFA設定
  - Authenticator appでroot MFAを設定

- 課金アラート（AWS Budgets）を設定
  - 予算の閾値でアラートを設定

## 成果（できたこと）
- tfstateをローカルではなく S3で管理する運用（Remote backend） を構築できた
- DynamoDBによるstate lock が plan/apply/destroy 時に動くことを確認できた
- Remote backendに切り替えた状態で、plan → apply → state確認 → destroy が一通り回せた
- root MFA と Budgets を設定し、セキュリティ＆課金事故対策ができた
- GitHub Actions等のCI/CDに繋げる前提が整った


## 実施内容（要点）

### bootstrap（state_backend）
```bash
cd infra/bootstrap/state_backend

terraform init
aws sts get-caller-identity --query Account --output text

terraform plan  -var "account_id=<ACCOUNT_ID>"
terraform apply -var "account_id=<ACCOUNT_ID>"

terraform output
```

### dev（Remote backend切り替え）
- `infra/envs/dev/backend.tf` を追加（値は直書き）

```hcl
terraform {
  backend "s3" {
    bucket         = "tomo-infra-study-tfstate-2457****1698"
    key            = "dev/terraform.tfstate"
    region         = "ap-northeast-1"
    dynamodb_table = "tomo-infra-study-tflock"
    encrypt        = true
  }
}
```

```bash
cd infra/envs/dev

terraform init
terraform init -migrate-state
```

#### ハマりポイント / 学び
- `terraform init -reconfigure -migrate-state` はエラー  
  → `-migrate-state` と `-reconfigure` は同時指定できない（用途に応じて片方を使う）
- backend設定で **bucket名とテーブル名を入れ違える**とエラーになる  
  → `bucket` はS3、`dynamodb_table` はDynamoDB

---

## Remote backend上での plan/apply/destroy 確認

### plan（ロック取得が出る）
```bash
terraform plan
```

### apply（VPC一式を作成）
```bash
terraform apply
```

（結果）
```text
Apply complete! Resources: 6 added, 0 changed, 0 destroyed.
```

### state確認（S3上のstateを確認）
```bash
terraform state list
terraform state pull | head
```

（state list）
```text
data.aws_availability_zones.available
aws_internet_gateway.this
aws_route_table.public
aws_route_table_association.public
aws_security_group.web
aws_subnet.public
aws_vpc.this
```

### destroy（後片付け）
```bash
terraform destroy
```

（結果）
```text
Destroy complete! Resources: 6 destroyed.
```

---

## セキュリティ / 課金対策
- root MFA（Authenticator app）設定済み
- AWS Budgetsで課金アラート設定（

---

## 次にやりたいこと
- GitHub ActionsでPR作成時に `terraform fmt/validate/plan` を自動実行
  - できればOIDCでAssumeRole（アクセスキーを置かない）
